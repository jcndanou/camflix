{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Ma liste à voir" %} - CamFlix{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">{% trans "Ma liste à voir" %}</h1>
            <p class="text-gray-400">
                {% if movies %}
                    {% blocktrans count counter=movies|length %}
                        {{ counter }} film dans votre liste
                    {% plural %}
                        {{ counter }} films dans votre liste
                    {% endblocktrans %}
                {% else %}
                    {% trans "Votre liste est vide" %}
                {% endif %}
            </p>
        </div>

        <!-- View Toggle -->
        <div x-data="{ view: 'grid' }" class="flex bg-gray-800 rounded-lg p-1">
            <button @click="view = 'grid'"
                    :class="view === 'grid' ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'"
                    class="px-3 py-2 rounded-md text-sm font-medium transition">
                <i class="fas fa-th"></i>
            </button>
            <button @click="view = 'list'"
                    :class="view === 'list' ? 'bg-purple-600 text-white' : 'text-gray-400 hover:text-white'"
                    class="px-3 py-2 rounded-md text-sm font-medium transition">
                <i class="fas fa-list"></i>
            </button>
        </div>
    </div>

    <!-- Filters & Sort -->
    {% if movies %}
    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div class="flex flex-wrap gap-4">
            <!-- Genre Filter -->
            <select class="bg-gray-800 text-white px-3 py-2 rounded-md text-sm border border-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="">{% trans "Tous les genres" %}</option>
                <option value="action">Action</option>
                <option value="comedy">Comédie</option>
                <option value="drama">Drame</option>
                <option value="horror">Horreur</option>
                <option value="sci-fi">Science-Fiction</option>
            </select>

            <!-- Year Filter -->
            <select class="bg-gray-800 text-white px-3 py-2 rounded-md text-sm border border-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="">{% trans "Toutes les années" %}</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
                <option value="2020">2020</option>
            </select>
        </div>

        <!-- Sort Options -->
        <select class="bg-gray-800 text-white px-3 py-2 rounded-md text-sm border border-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="added_desc">{% trans "Ajouté récemment" %}</option>
            <option value="added_asc">{% trans "Ajouté anciennement" %}</option>
            <option value="title_asc">{% trans "Titre A-Z" %}</option>
            <option value="title_desc">{% trans "Titre Z-A" %}</option>
            <option value="year_desc">{% trans "Année décroissante" %}</option>
            <option value="year_asc">{% trans "Année croissante" %}</option>
            <option value="rating_desc">{% trans "Note décroissante" %}</option>
            <option value="rating_asc">{% trans "Note croissante" %}</option>
        </select>
    </div>
    {% endif %}

    <!-- Watchlist Content -->
    {% if movies %}
    <div x-data="{ view: 'grid' }">
        <!-- Grid View -->
        <div x-show="view === 'grid'" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
            {% for movie in movies %}
            <div class="bg-gray-800 rounded-lg overflow-hidden hover:bg-gray-700 transition group relative">
                <!-- Remove Button -->
                <button class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition z-10"
                        onclick="removeFromWatchlist({{ movie.id }})">
                    <i class="fas fa-times text-xs"></i>
                </button>

                <a href="{% url 'movies:detail' movie.id %}">
                    <div class="aspect-[2/3] relative">
                        <img src="{{ movie.poster_url }}" alt="{{ movie.title }}"
                             class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">

                        <!-- Rating Badge -->
                        {% if movie.rating %}
                        <div class="absolute top-2 left-2">
                            <span class="bg-yellow-500 text-black px-2 py-1 rounded-full text-xs font-bold">
                                {{ movie.rating|floatformat:1 }}
                            </span>
                        </div>
                        {% endif %}

                        <!-- Watch Status -->
                        <div class="absolute bottom-2 left-2">
                            <span class="bg-purple-600 text-white px-2 py-1 rounded-full text-xs">
                                <i class="fas fa-bookmark mr-1"></i>{% trans "À voir" %}
                            </span>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="font-medium text-white text-sm mb-1 line-clamp-2">{{ movie.title }}</h3>
                        <p class="text-gray-400 text-xs mb-1">{{ movie.release_date|date:"Y" }}</p>
                        <p class="text-gray-500 text-xs">{% trans "Ajouté le" %} {{ movie.added_to_watchlist|date:"d/m/Y" }}</p>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>

        <!-- List View -->
        <div x-show="view === 'list'" class="space-y-4">
            {% for movie in movies %}
            <div class="bg-gray-800 rounded-lg p-4 flex items-center space-x-4 hover:bg-gray-700 transition">
                <!-- Poster -->
                <div class="flex-shrink-0">
                    <img src="{{ movie.poster_url }}" alt="{{ movie.title }}" class="w-16 h-24 object-cover rounded">
                </div>

                <!-- Movie Info -->
                <div class="flex-grow">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-white mb-1">
                                <a href="{% url 'movies:detail' movie.id %}" class="hover:text-purple-400 transition">
                                    {{ movie.title }}
                                </a>
                            </h3>
                            <p class="text-gray-400 text-sm mb-2">{{ movie.release_date|date:"Y" }} • {{ movie.genres.all|join:", " }}</p>
                            <p class="text-gray-500 text-sm">{% trans "Ajouté le" %} {{ movie.added_to_watchlist|date:"d/m/Y" }}</p>
                        </div>

                        <div class="flex items-center space-x-3">
                            <!-- Rating -->
                            {% if movie.rating %}
                            <div class="flex items-center">
                                <i class="fas fa-star text-yellow-400 text-sm mr-1"></i>
                                <span class="text-white text-sm">{{ movie.rating|floatformat:1 }}</span>
                            </div>
                            {% endif %}

                            <!-- Actions -->
                            <div class="flex space-x-2">
                                <a href="{% url 'movies:detail' movie.id %}"
                                   class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition">
                                    {% trans "Voir" %}
                                </a>
                                <button onclick="removeFromWatchlist({{ movie.id }})"
                                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition">
                                    {% trans "Retirer" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-16">
        <i class="fas fa-bookmark text-gray-600 text-6xl mb-6"></i>
        <h2 class="text-2xl font-semibold text-white mb-4">{% trans "Votre liste est vide" %}</h2>
        <p class="text-gray-400 mb-8 max-w-md mx-auto">
            {% trans "Ajoutez des films à votre liste pour les regarder plus tard. Cliquez sur l'icône marque-page sur n'importe quel film." %}
        </p>
        <div class="space-x-4">
            <a href="{% url 'movies:list' %}"
               class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition">
                {% trans "Découvrir des films" %}
            </a>
            <a href="{% url 'recommendations:for-you' %}"
               class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition">
                {% trans "Voir mes recommandations" %}
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
function removeFromWatchlist(movieId) {
    if (confirm('{% trans "Êtes-vous sûr de vouloir retirer ce film de votre liste ?" %}')) {
        fetch(`/movies/${movieId}/toggle-watchlist/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('{% trans "Une erreur est survenue" %}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Une erreur est survenue" %}');
        });
    }
}
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}